name: Build and Release

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release'
        required: false
        type: boolean
        default: true
      release_notes:
        description: 'Release notes (optional)'
        required: false
        type: string
  push:
    tags:
      - 'v*'

env:
  FLUTTER_VERSION: '3.29.0'
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  # Extract version from pubspec.yaml
  extract-version:
    name: Extract Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      version_code: ${{ steps.get-version.outputs.version_code }}
    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Extract version
        id: get-version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //; s/+.*//')
          VERSION_CODE=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION+$VERSION_CODE"

  # ANDROID BUILDS
  build-android-apk:
    name: Android APK Build
    runs-on: ubuntu-latest
    needs: extract-version
    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get Flutter version
        run: flutter --version

      - name: Get dependencies
        run: flutter pub get

      - name: Create default .env file
        run: |
          if [ -f ".env_example" ]; then
            cp .env_example .env
          else
            echo "# Empty env file for CI/CD" > .env
          fi

      - name: Decode and setup keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 -d > android/app/release-keystore.jks
            cat > android/key.properties << EOF
            storePassword=$STORE_PASSWORD
            keyPassword=$KEY_PASSWORD
            keyAlias=$KEY_ALIAS
            storeFile=release-keystore.jks
            EOF
            echo "âœ“ Keystore configured for signing"
          else
            echo "âš ï¸  No keystore configured - using debug signing"
            cat > android/key.properties << EOF
            storePassword=
            keyPassword=
            keyAlias=androiddebugkey
            storeFile=/tmp/debug.keystore
            EOF
            keytool -genkey -v -keystore /tmp/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          fi

      - name: Build Universal APK
        run: |
          flutter build apk \
            --release \
            --build-number=${{ needs.extract-version.outputs.version_code }} \
            --build-name=${{ needs.extract-version.outputs.version }}

      - name: Build Split APKs
        run: |
          # ARM64-v8a
          flutter build apk \
            --release \
            --split-per-abi \
            --target-platform android-arm64 \
            --build-number=${{ needs.extract-version.outputs.version_code }} \
            --build-name=${{ needs.extract-version.outputs.version }}

          # ARM32-v7a
          flutter build apk \
            --release \
            --split-per-abi \
            --target-platform android-arm \
            --build-number=${{ needs.extract-version.outputs.version_code }} \
            --build-name=${{ needs.extract-version.outputs.version }}

          # x86_64
          flutter build apk \
            --release \
            --split-per-abi \
            --target-platform android-x64 \
            --build-number=${{ needs.extract-version.outputs.version_code }} \
            --build-name=${{ needs.extract-version.outputs.version }}

      - name: Rename APKs
        run: |
          cd build/app/outputs/flutter-apk
          mv app-release.apk animestream-${{ needs.extract-version.outputs.version }}-universal.apk
          mv app-armeabi-v7a-release.apk animestream-${{ needs.extract-version.outputs.version }}-armeabi-v7a.apk 2>/dev/null || true
          mv app-arm64-v8a-release.apk animestream-${{ needs.extract-version.outputs.version }}-arm64-v8a.apk 2>/dev/null || true
          mv app-x86_64-release.apk animestream-${{ needs.extract-version.outputs.version }}-x86_64.apk 2>/dev/null || true

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: |
            build/app/outputs/flutter-apk/animestream-*.apk
          retention-days: 30

  build-android-aab:
    name: Android AAB Build
    runs-on: ubuntu-latest
    needs: extract-version
    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get Flutter version
        run: flutter --version

      - name: Get dependencies
        run: flutter pub get

      - name: Create default .env file
        run: |
          if [ -f ".env_example" ]; then
            cp .env_example .env
          else
            echo "# Empty env file for CI/CD" > .env
          fi

      - name: Decode and setup keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 -d > android/app/release-keystore.jks
            cat > android/key.properties << EOF
            storePassword=$STORE_PASSWORD
            keyPassword=$KEY_PASSWORD
            keyAlias=$KEY_ALIAS
            storeFile=release-keystore.jks
            EOF
            echo "âœ“ Keystore configured for signing"
          else
            echo "âš ï¸  No keystore configured - using debug signing"
            cat > android/key.properties << EOF
            storePassword=
            keyPassword=
            keyAlias=androiddebugkey
            storeFile=/tmp/debug.keystore
            EOF
            keytool -genkey -v -keystore /tmp/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          fi

      - name: Build AAB
        run: |
          flutter build appbundle \
            --release \
            --build-number=${{ needs.extract-version.outputs.version_code }} \
            --build-name=${{ needs.extract-version.outputs.version }}

      - name: Rename AAB
        run: |
          cd build/app/outputs/bundle/release
          mv app-release.aab animestream-${{ needs.extract-version.outputs.version }}.aab

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: |
            build/app/outputs/bundle/release/animestream-*.aab
          retention-days: 30

  # LINUX BUILDS
  build-linux:
    name: Linux Build
    runs-on: ubuntu-latest
    needs: extract-version
    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libstdc++-12-dev \
            libsecret-1-dev \
            libwebkit2gtk-4.1-dev

      - name: Get Flutter version
        run: flutter --version

      - name: Enable Linux desktop
        run: flutter config --enable-linux-desktop

      - name: Get dependencies
        run: flutter pub get

      - name: Create default .env file
        run: |
          if [ -f ".env_example" ]; then
            cp .env_example .env
          else
            echo "# Empty env file for CI/CD" > .env
          fi

      - name: Build Linux
        run: |
          flutter build linux \
            --release \
            --build-number=${{ needs.extract-version.outputs.version_code }} \
            --build-name=${{ needs.extract-version.outputs.version }}

      - name: Create AppImage
        run: |
          # Create AppDir structure
          APPDIR="AppDir"
          mkdir -p "$APPDIR/usr/bin"
          mkdir -p "$APPDIR/usr/share/applications"
          mkdir -p "$APPDIR/usr/share/icons/hicolor/512x512/apps"
          mkdir -p "$APPDIR/usr/lib"

          # Copy built files
          cp -r build/linux/x64/release/bundle/* "$APPDIR/usr/bin/"

          # Create desktop file
          cat > "$APPDIR/usr/share/applications/animestream.desktop" << 'EOF'
          [Desktop Entry]
          Name=animestream
          Exec=animestream
          Icon=animestream
          Type=Application
          Categories=AudioVideo;Video;
          EOF

          # Copy icon if exists, otherwise use placeholder
          if [ -f "lib/assets/icons/logo.png" ]; then
            cp lib/assets/icons/logo.png "$APPDIR/usr/share/icons/hicolor/512x512/apps/animestream.png"
          fi

          # Download appimagetool
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          # Create AppImage
          ARCH=x86_64 ./appimagetool-x86_64.AppImage "$APPDIR" "animestream-${{ needs.extract-version.outputs.version }}-x86_64.AppImage"

      - name: Create deb package
        run: |
          # Install packaging tools
          sudo apt-get install -y dpkg-dev

          # Create package structure
          PKGDIR="deb-package"
          mkdir -p "$PKGDIR/DEBIAN"
          mkdir -p "$PKGDIR/opt/animestream"
          mkdir -p "$PKGDIR/usr/share/applications"
          mkdir -p "$PKGDIR/usr/share/icons/hicolor/512x512/apps"

          # Copy files
          cp -r build/linux/x64/release/bundle/* "$PKGDIR/opt/animestream/"

          # Create control file
          cat > "$PKGDIR/DEBIAN/control" << EOF
          Package: animestream
          Version: ${{ needs.extract-version.outputs.version }}
          Architecture: amd64
          Maintainer: FrostNova
          Description: A app made to stream and download anime
           Animestream is a Flutter project made to stream and download Anime.
          Priority: optional
          Section: video
          EOF

          # Create desktop file
          cat > "$PKGDIR/usr/share/applications/animestream.desktop" << 'EOF'
          [Desktop Entry]
          Name=animestream
          Exec=/opt/animestream/animestream
          Icon=animestream
          Type=Application
          Categories=AudioVideo;Video;
          EOF

          # Copy icon
          if [ -f "lib/assets/icons/logo.png" ]; then
            cp lib/assets/icons/logo.png "$PKGDIR/usr/share/icons/hicolor/512x512/apps/animestream.png"
          fi

          # Build deb
          dpkg-deb --build "$PKGDIR" "animestream-${{ needs.extract-version.outputs.version }}-amd64.deb"

      - name: Create rpm package
        run: |
          # Install rpmbuild
          sudo apt-get install -y rpm

          # Create build directories
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p rpmbuild-root/opt/animestream
          mkdir -p rpmbuild-root/usr/share/applications
          mkdir -p rpmbuild-root/usr/share/icons/hicolor/512x512/apps

          # Copy files
          cp -r build/linux/x64/release/bundle/* rpmbuild-root/opt/animestream/

          # Create desktop file
          cat > rpmbuild-root/usr/share/applications/animestream.desktop << 'EOF'
          [Desktop Entry]
          Name=animestream
          Exec=/opt/animestream/animestream
          Icon=animestream
          Type=Application
          Categories=AudioVideo;Video;
          EOF

          # Copy icon
          if [ -f "lib/assets/icons/logo.png" ]; then
            cp lib/assets/icons/logo.png rpmbuild-root/usr/share/icons/hicolor/512x512/apps/animestream.png
          fi

          # Create spec file
          cat > ~/rpmbuild/SPECS/animestream.spec << EOF
          Name:           animestream
          Version:        ${{ needs.extract-version.outputs.version }}
          Release:        1%{?dist}
          Summary:        A app made to stream and download anime
          License:        GPL-3.0
          URL:            https://github.com/Shebyyy/animestream
          BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-root

          %description
          Animestream is a Flutter project made to stream and download Anime.

          %install
          rm -rf \$RPM_BUILD_ROOT
          mkdir -p \$RPM_BUILD_ROOT/opt/animestream
          mkdir -p \$RPM_BUILD_ROOT/usr/share/applications
          mkdir -p \$RPM_BUILD_ROOT/usr/share/icons/hicolor/512x512/apps

          cp -r $PWD/rpmbuild-root/opt/animestream/* \$RPM_BUILD_ROOT/opt/animestream/
          cp $PWD/rpmbuild-root/usr/share/applications/animestream.desktop \$RPM_BUILD_ROOT/usr/share/applications/
          cp $PWD/rpmbuild-root/usr/share/icons/hicolor/512x512/apps/animestream.png \$RPM_BUILD_ROOT/usr/share/icons/hicolor/512x512/apps/ 2>/dev/null || true

          %files
          /opt/animestream/*
          /usr/share/applications/animestream.desktop
          /usr/share/icons/hicolor/512x512/apps/animestream.png
          EOF

          # Build rpm
          rpmbuild -bb ~/rpmbuild/SPECS/animestream.spec
          cp ~/rpmbuild/RPMS/x86_64/animestream-*.rpm ./animestream-${{ needs.extract-version.outputs.version }}-x86_64.rpm

      - name: Create portable zip
        run: |
          cd build/linux/x64/release
          zip -r ../../../animestream-${{ needs.extract-version.outputs.version }}-linux-x64.zip bundle/

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            animestream-*.AppImage
            animestream-*.deb
            animestream-*.rpm
            animestream-*-linux-x64.zip
          retention-days: 30

  # WINDOWS BUILDS
  build-windows:
    name: Windows Build
    runs-on: windows-latest
    needs: extract-version
    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get Flutter version
        run: flutter --version

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Get dependencies
        run: flutter pub get

      - name: Create default .env file
        shell: pwsh
        run: |
          if (Test-Path ".env_example") { Copy-Item ".env_example" ".env" } else { "# Empty env file for CI/CD" | Out-File -Encoding UTF8 ".env" }

      - name: Build Windows
        shell: pwsh
        run: flutter build windows --release --build-number=${{ needs.extract-version.outputs.version_code }} --build-name=${{ needs.extract-version.outputs.version }}

      - name: Create portable zip
        shell: pwsh
        run: |
          cd build/windows/x64/runner/Release
          7z a ../../../animestream-${{ needs.extract-version.outputs.version }}-windows-x64-portable.zip .

      - name: Create installer
        shell: pwsh
        run: dart run inno_bundle:build --release

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: |
            build/windows/x64/runner/Release/*.zip
            build/windows/x64/installer/*.exe
            build/installer/*.exe
            build/windows/innosetup/*.exe
            *.exe
          retention-days: 30

  # MACOS BUILDS
  build-macos:
    name: macOS Build
    runs-on: macos-latest
    needs: extract-version
    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get Flutter version
        run: flutter --version

      - name: Enable macOS desktop
        run: flutter config --enable-macos-desktop

      - name: Get dependencies
        run: flutter pub get

      - name: Create default .env file
        run: |
          if [ -f ".env_example" ]; then
            cp .env_example .env
          else
            echo "# Empty env file for CI/CD" > .env
          fi

      - name: Build macOS
        run: |
          flutter build macos \
            --release \
            --build-number=${{ needs.extract-version.outputs.version_code }} \
            --build-name=${{ needs.extract-version.outputs.version }}

      - name: Create DMG
        run: |
          # Create a temporary directory for DMG content
          mkdir dmg_temp

          # Copy the app bundle
          cp -R build/macos/Build/Products/Release/animestream.app dmg_temp/

          # Create symlink to Applications folder
          ln -s /Applications dmg_temp/Applications

          # Create DMG using hdiutil
          hdiutil create \
            -volname "animestream" \
            -srcfolder dmg_temp \
            -ov \
            -format UDZO \
            animestream-${{ needs.extract-version.outputs.version }}-macos.dmg

      - name: Create app bundle zip
        run: |
          cd build/macos/Build/Products/Release
          zip -r ../../../../animestream-${{ needs.extract-version.outputs.version }}-macos.zip animestream.app

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: |
            animestream-*.dmg
            animestream-*-macos.zip
          retention-days: 30

  # IOS BUILD
  build-ios:
    name: iOS Build
    runs-on: macos-latest
    needs: extract-version
    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get Flutter version
        run: flutter --version

      - name: Clean iOS build artifacts
        run: |
          cd ios
          rm -rf Pods/
          rm -rf build/
          rm -f Podfile.lock
          rm -rf Runner.xcworkspace/xcuserdata
          rm -rf Runner.xcodeproj/xcuserdata

      - name: Get dependencies
        run: flutter pub get

      - name: Create default .env file
        run: |
          if [ -f ".env_example" ]; then
            cp .env_example .env
          else
            echo "# Empty env file for CI/CD" > .env
          fi

      - name: Build iOS (no codesign)
        run: |
          flutter build ios \
            --release \
            --no-codesign \
            --build-number=${{ needs.extract-version.outputs.version_code }} \
            --build-name=${{ needs.extract-version.outputs.version }}

      - name: Archive and export IPA
        run: |
          cd build/ios/iphoneos
          zip -r ../../../animestream-${{ needs.extract-version.outputs.version }}-ios-unsigned.ipa Runner.app

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-builds
          path: |
            animestream-*-ios-unsigned.ipa
          retention-days: 30
        continue-on-error: true

  # CREATE RELEASE
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs:
      - extract-version
      - build-android-apk
      - build-android-aab
      - build-linux
      - build-windows
      - build-macos
      - build-ios
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.create_release == true || github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') }}
    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f

      - name: Generate Release Notes
        id: release-notes
        run: |
          if [ -n "${{ inputs.release_notes }}" ]; then
            NOTES="${{ inputs.release_notes }}"
          else
            cat > release_notes.md << 'EOF'
          # ðŸŽ¬ animestream v${{ needs.extract-version.outputs.version }}

          ## ðŸ“¦ Download Options

          ### Android
          - **Universal APK**: Works on all devices (larger size)
          - **Split APKs**: Choose your architecture (smaller size)
            - `arm64-v8a`: Modern devices (ARM64)
            - `armeabi-v7a`: Older devices (ARM32)
            - `x86_64`: Emulators and x86 devices
          - **AAB**: For Google Play Store

          ### Linux
          - **AppImage**: Universal package, no installation required
          - **deb**: Debian/Ubuntu/Mint
          - **rpm**: Fedora/openSUSE/RHEL
          - **Zip**: Portable binary build

          ### Windows
          - **Installer**: EXE setup file with installation wizard
          - **Portable Zip**: Extract and run, no installation required

          ### macOS
          - **DMG**: Disk image with drag-and-drop installation
          - **Zip**: App bundle

          ### iOS
          - **Unsigned IPA**: For testing purposes (sideloading)

          ## ðŸš€ Installation

          ### Android
          Download the APK that matches your device architecture, then install it. You may need to enable "Unknown Sources" in your security settings.

          ### Linux
          - **AppImage**: Make it executable: `chmod +x animestream-*.AppImage` and run
          - **deb**: `sudo dpkg -i animestream-*.deb`
          - **rpm**: `sudo rpm -i animestream-*.rpm`

          ### Windows
          - **Installer**: Double-click the .exe file and follow the wizard
          - **Portable**: Extract the zip and run animestream.exe

          ### macOS
          - **DMG**: Open and drag animestream.app to Applications
          - **Zip**: Extract and move animestream.app to Applications

          ### iOS
          The unsigned IPA is for testing. Use AltStore or similar tools to sideload.

          ## ðŸ“ Changelog

          See [changelog.md](https://github.com/Shebyyy/animestream/blob/master/changelog.md) for detailed changes.

          ## âš ï¸ Disclaimer

          By using this app, you agree that the developer(s) of animestream is not responsible for any content within the app.
          EOF
            NOTES=$(cat release_notes.md)
          fi
          {
            echo 'notes<<EOF'
            echo "$NOTES"
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.extract-version.outputs.version }}
          name: animestream v${{ needs.extract-version.outputs.version }}
          body: ${{ steps.release-notes.outputs.notes }}
          draft: false
          prerelease: false
          files: |
            artifacts/android-apks/animestream-*.apk
            artifacts/android-aab/animestream-*.aab
            artifacts/linux-builds/animestream-*.AppImage
            artifacts/linux-builds/animestream-*.deb
            artifacts/linux-builds/animestream-*.rpm
            artifacts/linux-builds/animestream-*-linux-x64.zip
            artifacts/windows-builds/animestream-*.zip
            artifacts/windows-builds/animestream-*.exe
            artifacts/macos-builds/animestream-*.dmg
            artifacts/macos-builds/animestream-*-macos.zip
            artifacts/ios-builds/animestream-*-ios-unsigned.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
